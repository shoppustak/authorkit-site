let currentPage=1,currentGenre=null,currentSearch="",currentSort="latest",totalPages=1;function setupEventListeners(){document.getElementById("search-input").addEventListener("input",debounce(e=>{currentSearch=e.target.value,currentPage=1,updateUrlParams({search:currentSearch,page:currentPage}),loadBooks()},500));const e=document.querySelectorAll('input[name="genre"]');e.forEach(t=>{t.addEventListener("change",t=>{if("all"===t.target.value)e.forEach(e=>{"all"!==e.value&&(e.checked=!1)}),currentGenre=null;else{document.querySelector('input[name="genre"][value="all"]').checked=!1;const n=Array.from(e).filter(e=>e.checked&&"all"!==e.value).map(e=>e.value);e.forEach(e=>{"all"!==e.value&&e.value!==t.target.value&&(e.checked=!1)}),currentGenre=n[0]||null}currentPage=1,updateUrlParams({genre:currentGenre,page:currentPage}),loadBooks()})});document.getElementById("sort-select").addEventListener("change",e=>{currentSort=e.target.value,currentPage=1,updateUrlParams({sort:currentSort,page:currentPage}),loadBooks()});document.getElementById("reset-filters").addEventListener("click",()=>{currentGenre=null,currentSearch="",currentSort="latest",currentPage=1,document.getElementById("search-input").value="",document.getElementById("sort-select").value="latest",document.querySelectorAll('input[name="genre"]').forEach(e=>{e.checked="all"===e.value}),updateUrlParams({genre:null,search:null,sort:null,page:null}),loadBooks()})}async function loadBooks(){const e=document.getElementById("books-grid"),t=document.getElementById("results-count");e.innerHTML='<div class="loading">Loading books...</div>',t.textContent="Loading...";try{const n=new URLSearchParams({page:currentPage,limit:20,sort:currentSort});currentGenre&&n.append("genre",currentGenre),currentSearch&&n.append("search",currentSearch);const r=await fetch(`/api/bookshelf/books?${n.toString()}`),a=await r.json();if(!a.success)throw new Error(a.error||"Failed to load books");totalPages=a.pagination.pages;const{total:o,page:c,limit:l}=a.pagination,u=(c-1)*l+1,s=Math.min(c*l,o);t.textContent=0===o?"No books found":`Showing ${u}-${s} of ${o} books`,e.innerHTML="",0===a.books.length?e.innerHTML='<p class="no-books">No books found matching your filters. Try adjusting your search or genre selection.</p>':a.books.forEach(t=>{e.appendChild(createBookCard(t))}),renderPagination(a.pagination),window.scrollTo({top:0,behavior:"smooth"})}catch(n){console.error("Failed to load books:",n),e.innerHTML='<p class="error">Failed to load books. Please try again later.</p>',t.textContent="Error loading books"}}function renderPagination(e){const t=document.getElementById("pagination");if(t.innerHTML="",e.pages<=1)return;const{page:n,pages:r}=e,a=document.createElement("button");a.className="page-btn",a.textContent="← Previous",a.disabled=1===n,a.addEventListener("click",()=>{n>1&&(currentPage=n-1,updateUrlParams({page:currentPage}),loadBooks())}),t.appendChild(a);let o=Math.max(1,n-Math.floor(3.5)),c=Math.min(r,o+7-1);if(c-o<6&&(o=Math.max(1,c-7+1)),o>1){const e=createPageButton(1,n);if(t.appendChild(e),o>2){const e=document.createElement("span");e.textContent="...",e.style.padding="10px",t.appendChild(e)}}for(let e=o;e<=c;e++){const r=createPageButton(e,n);t.appendChild(r)}if(c<r){if(c<r-1){const e=document.createElement("span");e.textContent="...",e.style.padding="10px",t.appendChild(e)}const e=createPageButton(r,n);t.appendChild(e)}const l=document.createElement("button");l.className="page-btn",l.textContent="Next →",l.disabled=n===r,l.addEventListener("click",()=>{n<r&&(currentPage=n+1,updateUrlParams({page:currentPage}),loadBooks())}),t.appendChild(l)}function createPageButton(e,t){const n=document.createElement("button");return n.className="page-btn",n.textContent=e,e===t&&n.classList.add("active"),n.addEventListener("click",()=>{window.currentPage=e,updateUrlParams({page:e}),loadBooks()}),n}document.addEventListener("DOMContentLoaded",()=>{if(currentGenre=getUrlParam("genre"),currentSearch=getUrlParam("search")||"",currentSort=getUrlParam("sort")||"latest",currentPage=parseInt(getUrlParam("page"))||1,currentGenre){const e=document.querySelector(`input[name="genre"][value="${currentGenre}"]`);e&&(e.checked=!0,document.querySelector('input[name="genre"][value="all"]').checked=!1)}currentSearch&&(document.getElementById("search-input").value=currentSearch),currentSort&&(document.getElementById("sort-select").value=currentSort),setupEventListeners(),loadBooks()});